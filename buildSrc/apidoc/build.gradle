/*
 * Copyright ish group pty ltd 2020.
 *
 * This program is free software: you can redistribute it and/or modify it under the terms of the
 * GNU Affero General Public License version 3 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Affero General Public License for more details.
 */

apply plugin: 'groovy'

repositories {
	mavenCentral()
}

dependencies {
	implementation gradleApi()
	implementation 'antlr:antlr:2.7.7'
	implementation 'org.apache.ant:ant-antlr:1.9.6'
	implementation project.fileTree(include: ['*.jar'], dir: "${project.rootDir}/buildSrc/apidoc/build/libs/")

	testImplementation 'junit:junit:4.11'
}

sourceCompatibility = JavaVersion.VERSION_11

task generateGrammar {
	description = 'Ensure all the Antlr generated files are up to date.'
	ext.antlrDirectory = "$projectDir/src/main/java/au/com/ish/docs/antlr"
	ext.javaParserDirectory = "$ext.antlrDirectory"
	ext.genPath = "$ext.antlrDirectory"
	ext.groovyOutDir = "$ext.genPath/groovy"
	ext.javaOutDir = "$ext.genPath/java"
	inputs.dir(antlrDirectory)
	outputs.dir(groovyOutDir)
	outputs.dir(javaOutDir)
	doFirst {
		new File(groovyOutDir).mkdirs()
		new File(javaOutDir).mkdirs()
		ant {
			taskdef(name: 'antlr',
					classname: 'org.apache.tools.ant.taskdefs.optional.ANTLR',
					classpath: configurations.antlr.asPath)

			antlr(target: "$ext.antlrDirectory/groovy.g", outputdirectory: ext.groovyOutDir) {
				classpath path: configurations.compile.asPath
			}
			antlr(target: "$ext.javaParserDirectory/java.g", outputdirectory: ext.javaOutDir) {
				classpath path: configurations.compile.asPath
			}
		}
	}
}
