<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

	<changeSet id="cleanChangeLog" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<tableExists tableName="DATABASECHANGELOG"/>
		</preConditions>
		<sql>
			DELETE FROM DATABASECHANGELOG;
		</sql>
	</changeSet>

	<changeSet id="1" author="pavel" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="limitPreviousEnrolment" tableName="Discount"/>
			</not>
		</preConditions>
		<addColumn tableName="Discount">
			<column name="limitPreviousEnrolment" type="SMALLINT"/>
		</addColumn>
	</changeSet>

	<changeSet id="2" author="pavel" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="colour" tableName="Tag"/>
			</not>
		</preConditions>
		<addColumn tableName="Tag">
			<column name="colour" type="CHAR(6)"/>
		</addColumn>
	</changeSet>

	<changeSet id="3" author="pavel" runOnChange="false" runAlways="false" context="production">
		<sql>UPDATE Discount SET limitPreviousEnrolment = 0</sql>
	</changeSet>

	<changeSet id="4" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="dataType" tableName="CustomFieldType"/>
			</not>
		</preConditions>
		<addColumn tableName="CustomFieldType">
			<column name="dataType" type="SMALLINT"/>
		</addColumn>
	</changeSet>

	<changeSet id="5" author="artyom" runOnChange="false" runAlways="false" context="production">
		<sql>ALTER TABLE PaymentIn MODIFY COLUMN statusNotes MEDIUMTEXT</sql>
	</changeSet>

	<changeSet id="6" author="artyom" runOnChange="false" runAlways="false" context="production">
		<sql>ALTER TABLE EmailTemplate DROP FOREIGN KEY fk_EmailTemplate_College</sql>
		<sql>ALTER TABLE EmailTemplate DROP INDEX college_name</sql>
		<sql>ALTER TABLE EmailTemplate ADD FOREIGN KEY (collegeId) REFERENCES College(id)</sql>

	</changeSet>

	<changeSet id="7" author="artyom" runOnChange="false" runAlways="false" context="production">
		<sql>ALTER TABLE Script DROP FOREIGN KEY fk_Script_College</sql>
		<sql>ALTER TABLE Script DROP INDEX college_name</sql>
		<sql>ALTER TABLE Script ADD FOREIGN KEY (collegeId) REFERENCES College(id)</sql>

	</changeSet>

	<changeSet id="8" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<modifyDataType tableName="Course" columnName="code" newDataType="VARCHAR(128)"/>
	</changeSet>

	<changeSet id="9" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="EntityRelationType"/>
			</not>
		</preConditions>
		<createTable tableName="EntityRelationType">
			<column name="id" type="BIGINT" autoIncrement="true" >
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="created" type="datetime" />
			<column name="modified" type="datetime" />
			<column name="name" type="VARCHAR(100)" />
			<column name="toName" type="VARCHAR(100)" />
			<column name="fromName" type="VARCHAR(100)" />
			<column name="description" type="TEXT" />
			<column name="isShownOnWeb" type="SMALLINT" />
			<column name="shoppingCart" type="SMALLINT" />
			<column name="considerHistory" type="SMALLINT" />
			<column name="discountId" type="BIGINT" />
			<column name="collegeId" type="BIGINT" />
			<column name="angelId" type="BIGINT" />
		</createTable>
	</changeSet>

	<changeSet id="10" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="EntityRelation" columnName="typeId"/>
			</not>
		</preConditions>
		<addColumn tableName="EntityRelation">
			<column name="typeId" type="BIGINT" />
		</addColumn>
	</changeSet>

	<changeSet id="11" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="fk_EntityRelation_Type"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseTableName="EntityRelation"
								 baseColumnNames="typeId"
								 constraintName="fk_EntityRelation_Type"
								 referencedTableName="EntityRelationType"
								 referencedColumnNames="id"
								 validate="true"/>
	</changeSet>

	<changeSet id="12" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="EntityRelationType_Discount_fk"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseTableName="EntityRelationType"
								 baseColumnNames="discountId"
								 constraintName="EntityRelationType_Discount_fk"
								 referencedTableName="Discount"
								 referencedColumnNames="id"
								 validate="true"/>
	</changeSet>

	<changeSet id="13" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="EntityRelation" columnName="fromEntityIdentifierTemp"/>
			</not>
		</preConditions>
		<addColumn tableName="EntityRelation">
			<column name="fromEntityIdentifierTemp" type="VARCHAR(100)" />
		</addColumn>
	</changeSet>

	<changeSet id="14" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="EntityRelation" columnName="toEntityIdentifierTemp"/>
			</not>
		</preConditions>
		<addColumn tableName="EntityRelation">
			<column name="toEntityIdentifierTemp" type="VARCHAR(100)" />
		</addColumn>
	</changeSet>

	<changeSet id="15" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifierTemp"/>
		</preConditions>
		<update tableName="EntityRelation">
			<column name="fromEntityIdentifierTemp" value="Course" />
			<where>fromEntityIdentifier=1</where>
		</update>
	</changeSet>

	<changeSet id="16" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifierTemp"/>
		</preConditions>
		<update tableName="EntityRelation">
			<column name="toEntityIdentifierTemp" value="Course" />
			<where>toEntityIdentifier=1</where>
		</update>
	</changeSet>

	<changeSet id="17" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifierTemp"/>
		</preConditions>
		<update tableName="EntityRelation">
			<column name="toEntityIdentifierTemp" value="Product" />
			<where>toEntityIdentifier=2</where>
		</update>
	</changeSet>

	<changeSet id="18" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifier"/>
		</preConditions>
		<dropNotNullConstraint tableName="EntityRelation" columnName="fromEntityIdentifier" columnDataType="SMALLINT" />
	</changeSet>

	<changeSet id="19" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifier"/>
		</preConditions>
		<dropNotNullConstraint tableName="EntityRelation" columnName="toEntityIdentifier" columnDataType="SMALLINT" />
	</changeSet>

	<changeSet id="20" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifier"/>
		</preConditions>
		<modifyDataType tableName="EntityRelation" columnName="fromEntityIdentifier" newDataType="VARCHAR(100)" />
	</changeSet>

	<changeSet id="21" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifier"/>
		</preConditions>
		<modifyDataType tableName="EntityRelation" columnName="toEntityIdentifier" newDataType="VARCHAR(100)" />
	</changeSet>

	<changeSet id="22" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifier"/>
		</preConditions>
		<sql>UPDATE EntityRelation SET fromEntityIdentifier = fromEntityIdentifierTemp</sql>
	</changeSet>

	<changeSet id="23" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifier"/>
		</preConditions>
		<sql>UPDATE EntityRelation SET toEntityIdentifier = toEntityIdentifierTemp</sql>
	</changeSet>

	<changeSet id="24" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifier"/>
		</preConditions>
		<addNotNullConstraint tableName="EntityRelation" columnName="fromEntityIdentifier" columnDataType="VARCHAR(100)" />
	</changeSet>

	<changeSet id="25" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifier"/>
		</preConditions>
		<addNotNullConstraint tableName="EntityRelation" columnName="toEntityIdentifier" columnDataType="VARCHAR(100)" />
	</changeSet>

	<changeSet id="26" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifierTemp"/>
		</preConditions>
		<dropColumn tableName="EntityRelation" columnName="fromEntityIdentifierTemp" />
	</changeSet>

	<changeSet id="27" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifierTemp"/>
		</preConditions>
		<dropColumn tableName="EntityRelation" columnName="toEntityIdentifierTemp" />
	</changeSet>

	<changeSet id="28" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="Checkout"/>
			</not>
		</preConditions>
		<createTable tableName="Checkout">
			<column name="id" type="BIGINT" autoIncrement="true" >
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="created" type="datetime" />
			<column name="modified" type="datetime" />
			<column name="collegeId" type="BIGINT" />
			<column name="angelId" type="BIGINT" />
			<column name="UUID" type="VARCHAR(30)" >
				<constraints nullable="false"/>
			</column>
			<column name="shoppingCart" type="JSON" >
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="29" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<and>
				<columnExists tableName="AssessmentSubmission" columnName="studentComments"/>
				<columnExists tableName="AssessmentSubmission" columnName="tutorComments"/>
			</and>
		</preConditions>
		<dropColumn tableName="AssessmentSubmission">
			<column name="studentComments"/>
			<column name="tutorComments"/>
		</dropColumn>
	</changeSet>

	<changeSet id="30" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<and>
					<columnExists tableName="AssessmentSubmission" columnName="submittedOn"/>
					<columnExists tableName="AssessmentSubmission" columnName="markedOn"/>
				</and>
			</not>
		</preConditions>
		<addColumn tableName="AssessmentSubmission">
			<column name="submittedOn" type="datetime"/>
			<column name="markedOn" type="datetime"/>
		</addColumn>
	</changeSet>

	<changeSet id="31" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="AssessmentSubmission" columnName="submittedById"/>
		</preConditions>
		<dropNotNullConstraint tableName="AssessmentSubmission" columnName="submittedById" columnDataType="BIGINT"/>
	</changeSet>

	<changeSet id="32" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="AssessmentSubmission" columnName="submittedById"/>
		</preConditions>
		<renameColumn tableName="AssessmentSubmission" oldColumnName="submittedById" newColumnName="markedById" columnDataType="BIGINT"/>
	</changeSet>
	<changeSet id="33" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="WebLayoutPath"/>
			</not>
		</preConditions>
		<createTable tableName="WebLayoutPath">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="created" type="datetime">
				<constraints nullable="false"/>
			</column>
			<column name="modified" type="datetime">
				<constraints nullable="false"/>
			</column>
			<column name="path" type="VARCHAR(200)">
				<constraints nullable="false"/>
			</column>
			<column name="webNodeTypeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="webSiteVersionId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addForeignKeyConstraint baseTableName="WebLayoutPath"
								 baseColumnNames="webNodeTypeId"
								 constraintName="WebLayoutPath_WebNodeType_fk"
								 referencedTableName="WebNodeType"
								 referencedColumnNames="id"
								 validate="true"/>
		<addForeignKeyConstraint baseTableName="WebLayoutPath"
								 baseColumnNames="webSiteVersionId"
								 constraintName="WebLayoutPath_WebSiteVersion_fk"
								 referencedTableName="WebSiteVersion"
								 referencedColumnNames="id"
								 validate="true"/>
		<createIndex indexName="WebLayoutPath_path" tableName="WebLayoutPath">
			<column name="path"/>
		</createIndex>
	</changeSet>

	<changeSet id="34" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="WebNode" columnName="webNodeTypeId"/>
		</preConditions>
		<dropNotNullConstraint tableName="WebNode" columnName="webNodeTypeId" columnDataType="BIGINT"/>
	</changeSet>

	<changeSet id="35" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="matchType" tableName="WebLayoutPath"/>
			</not>
		</preConditions>
		<addColumn tableName="WebLayoutPath">
			<column name="matchType" type="SMALLINT">
				<constraints nullable="false" />
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="36" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="GradingType"/>
			</not>
		</preConditions>
		<createTable tableName="GradingType">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="angelId" type="BIGINT"/>
			<column name="collegeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="created" type="datetime"/>
			<column name="modified" type="datetime"/>
			<column name="name" type="VARCHAR(128)">
				<constraints nullable="false"/>
			</column>
			<column name="min_value" type="DECIMAL(6,2)">
				<constraints nullable="false"/>
			</column>
			<column name="max_value" type="DECIMAL(6,2)">
				<constraints nullable="false"/>
			</column>
			<column name="entryType" type="SMALLINT">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="37" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="GradingItem"/>
			</not>
		</preConditions>
		<createTable tableName="GradingItem">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="angelId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="collegeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="created" type="datetime">
				<constraints nullable="false"/>
			</column>
			<column name="modified" type="datetime">
				<constraints nullable="false"/>
			</column>
			<column name="name" type="VARCHAR(128)">
				<constraints nullable="false"/>
			</column>
			<column name="lowerBound" type="DECIMAL(6,2)">
				<constraints nullable="false"/>
			</column>
			<column name="gradingTypeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addForeignKeyConstraint baseTableName="GradingItem"
								 baseColumnNames="gradingTypeId"
								 constraintName="fk_GradingItem_type"
								 referencedTableName="GradingType"
								 referencedColumnNames="id"
								 validate="true"/>
	</changeSet>

	<changeSet id="38" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="gradingTypeId" tableName="Assessment"/>
			</not>
		</preConditions>
		<addColumn tableName="Assessment">
			<column name="gradingTypeId" type="BIGINT"/>
		</addColumn>
		<addForeignKeyConstraint baseTableName="Assessment"
								 baseColumnNames="gradingTypeId"
								 constraintName="fk_Assessment_GradingType"
								 referencedTableName="GradingType"
								 referencedColumnNames="id"
								 validate="true"/>
	</changeSet>

	<changeSet id="39" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="grade" tableName="AssessmentSubmission"/>
			</not>
		</preConditions>
		<addColumn tableName="AssessmentSubmission">
			<column name="grade" type="DECIMAL(6,2)"/>
		</addColumn>
	</changeSet>

	<changeSet id="40" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="pattern" tableName="CustomFieldType"/>
			</not>
		</preConditions>
		<addColumn tableName="CustomFieldType">
			<column name="pattern" type="VARCHAR(128)"/>
		</addColumn>
	</changeSet>

	<changeSet id="41" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="fieldConfigurationSchemeId" tableName="Product"/>
			</not>
		</preConditions>
		<addColumn tableName="Product">
			<column name="fieldConfigurationSchemeId" type="BIGINT"/>
		</addColumn>
	</changeSet>

	<changeSet id="42" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists columnName="fieldConfigurationSchemeId" tableName="Product"/>
		</preConditions>
		<addForeignKeyConstraint baseTableName="Product"
								 baseColumnNames="fieldConfigurationSchemeId"
								 constraintName="fk_Product_FieldConfigurationScheme"
								 referencedTableName="FieldConfigurationScheme"
								 referencedColumnNames="id"
								 validate="true"/>
	</changeSet>

	<changeSet id="43" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="sessionId" tableName="SystemUser"/>
			</not>
		</preConditions>
		<addColumn tableName="SystemUser">
			<column name="sessionId" type="VARCHAR(256)"/>
		</addColumn>
	</changeSet>

	<changeSet id="44" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="User"/>
			</not>
		</preConditions>
		<createTable tableName="User">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="created" type="datetime"/>
			<column name="modified" type="datetime"/>
			<column name="lastLogin" type="datetime"/>

			<column name="email" type="VARCHAR(512)">
				<constraints nullable="false" unique="true" uniqueConstraintName="User_email_uniq"/>
			</column>
			<column name="emailVerified" type="SMALLINT"/>
			<column name="profilePicture" type="VARCHAR(512)"/>
			<column name="passwordHash" type="VARCHAR(512)"/>
		</createTable>

		<createTable tableName="UserAccount">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="created" type="datetime"/>
			<column name="modified" type="datetime"/>
			<column name="type" type="SMALLINT">
				<constraints nullable="false"/>
			</column>
			<column name="userId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addForeignKeyConstraint baseTableName="UserAccount"
														 baseColumnNames="userId"
														 constraintName="UserAccount_User_fk"
														 referencedTableName="User"
														 referencedColumnNames="id"
														 validate="true"/>
		<addUniqueConstraint columnNames="type, userId"
													constraintName="User_type_uniq"
													tableName="UserAccount"
													validate="true"/>
		<createTable tableName="UserAccountProperty">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="created" type="datetime"/>
			<column name="modified" type="datetime"/>
			<column name="name" type="VARCHAR(512)">
				<constraints nullable="false"/>
			</column>
			<column name="value" type="VARCHAR(512)">
				<constraints nullable="false"/>
			</column>
			<column name="userAccountId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addForeignKeyConstraint baseTableName="UserAccountProperty"
														 baseColumnNames="userAccountId"
														 constraintName="UserAccountProperty_UserAccount_fk"
														 referencedTableName="UserAccount"
														 referencedColumnNames="id"
														 validate="true"/>
		<addUniqueConstraint columnNames="userAccountId, name"
												 constraintName="account_property_uniq"
												 tableName="UserAccountProperty"
												 validate="true"/>
	</changeSet>

	<changeSet id="45" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="title" tableName="Invoice"/>
				<columnExists tableName="leadId" columnName="Invoice"/>
			</not>
		</preConditions>
		<addColumn tableName="Invoice">
			<column name="title" type="VARCHAR(200)"/>
			<column name="leadId" type="BIGINT"/>
		</addColumn>
	</changeSet>

	<changeSet id="46" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists columnName="allowAutoPay" tableName="Invoice"/>
		</preConditions>
		<dropNotNullConstraint tableName="Invoice" columnName="allowAutoPay" columnDataType="TINYINT"/>
	</changeSet>

	<changeSet id="47" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists columnName="invoiceNumber" tableName="Invoice"/>
		</preConditions>
		<dropNotNullConstraint tableName="Invoice" columnName="invoiceNumber" columnDataType="BIGINT"/>
	</changeSet>
	
	<changeSet id="48" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="HALT">
			<not>
				<columnExists tableName="SessionTutor" columnName="startDate" />
				<columnExists tableName="SessionTutor" columnName="endDate"/>
			</not>
		</preConditions>
		<addColumn tableName="SessionTutor">
			<column name="startDate" type="DATETIME"/>
			<column name="endDate" type="DATETIME"/>
		</addColumn>
	</changeSet>
	
	<changeSet id="49" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="HALT">
			<columnExists tableName="SessionTutor" columnName="startDate" />
			<columnExists tableName="SessionTutor" columnName="endDate"/>
		</preConditions>
		<sql>
			UPDATE SessionTutor st
			JOIN `Session` s ON  st.sessionId = s.id
			SET st.startDate = s.startDate, st.endDate = s.endDate
		</sql>
	</changeSet>

<!--	Can set not null Constraint only after update services (replication)-->
<!--	<changeSet id="50" author="artyom" runOnChange="false" runAlways="false" context="production">-->
<!--		<addNotNullConstraint tableName="SessionTutor" columnName="startDate" columnDataType="DATETIME" />-->
<!--		<addNotNullConstraint tableName="SessionTutor" columnName="endDate" columnDataType="DATETIME" />-->
<!--	</changeSet>-->

	<changeSet id="48" author="dmitriy" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="HALT">
			<not>
				<columnExists tableName="WebSite" columnName="configuredByUserId"/>
			</not>
		</preConditions>
		<addColumn tableName="WebSite">
			<column name="configuredByUserId" type="BIGINT"/>
		</addColumn>
		<addForeignKeyConstraint baseTableName="WebSite"
														 baseColumnNames="configuredByUserId"
														 constraintName="Website_ConfiguredBySystemUser_fk"
														 referencedTableName="SystemUser"
														 referencedColumnNames="id"
														 validate="true"/>
	</changeSet>

	<changeSet id="49" author="dmitriy" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="HALT">
			<columnExists tableName="WebSite" columnName="googleTagmanagerAccount"/>
		</preConditions>
		<renameColumn tableName="WebSite" oldColumnName="googleTagmanagerAccount" newColumnName="googleTagmanagerContainer"/>
	</changeSet>
</databaseChangeLog>
