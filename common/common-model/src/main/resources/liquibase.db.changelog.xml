<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	<!-- if once executed changeSet is updated, checksum will failed, so, create 
		the new changeSet item for the new update see http://www.liquibase.org/manual/changeset -->
	<changeSet id="1" author="ksenia" context="production"
		runOnChange="true">
		<!-- if precondition fail, the further changes are not performed -->
		<preConditions onFail="MARK_RAN">
			<indexExists indexName="collegeId_invoiceNumber_uniq_idx" />
		</preConditions>
		<dropNotNullConstraint tableName="Invoice"
			columnName="invoiceNumber" columnDataType="BIGINT" />
		<dropForeignKeyConstraint constraintName="Invoice_ibfk_1"
			baseTableName="Invoice" />
		<dropIndex tableName="Invoice" indexName="collegeId_invoiceNumber_uniq_idx" />
		<addForeignKeyConstraint constraintName="Invoice_ibfk_1"
			baseTableName="Invoice" baseColumnNames="collegeId"
			referencedTableName="College" referencedColumnNames="id" />
	</changeSet>

	<changeSet id="2" author="anton" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="College" columnName="communication_key" />
			</not>
		</preConditions>
		<addColumn tableName="College">
			<column name="communication_key" type="bigint" />
		</addColumn>
		<addColumn tableName="College">
			<column name="communication_key_status" type="varchar(20)" />
		</addColumn>
		<sql>update College set communication_key=(select c.communication_key
			from CommunicationKey c where c.collegeId=id and
			communication_key_type='REPLICATION')</sql>
		<sql>update College set communication_key_status=(select
			c.communication_key_status from CommunicationKey c where
			c.collegeId=id and communication_key_type='REPLICATION')</sql>
		<dropTable tableName="CommunicationKey" />
	</changeSet>

	<changeSet id="3" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="CONTINUE"
			onFailMessage="There are path duplicates in WebURLAlias">
			<sqlCheck expectedResult="0">
				SELECT count(*) FROM (SELECT
				webSiteId, urlPath, count(*) FROM WebURLAlias GROUP BY webSiteId,
				urlPath HAVING count(*) > 1) duplicates
			</sqlCheck>
		</preConditions>
		<comment>If the precondition fails, then there are the duplicates: WebURLAlias  with the same webSiteId and urlPath or the index has been already created</comment>
		<modifyDataType tableName="WebURLAlias" columnName="urlPath"
			newDataType="varchar(100)" />
		<addUniqueConstraint tableName="WebURLAlias"
			columnNames="webSiteId,urlPath" constraintName="urlalias_unique" />
	</changeSet>

	<changeSet id="4" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="Instruction" columnName="type" />
		</preConditions>
		<dropColumn tableName="Instruction" columnName="type" />
		<addColumn tableName="Instruction">
			<column name="message" type="varchar(100)" />
		</addColumn>
	</changeSet>

	<changeSet id="5" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="Instruction" columnName="response" />
				<columnExists tableName="Instruction" columnName="executed" />
			</not>
		</preConditions>
		<addColumn tableName="Instruction">
			<column name="response" type="varchar(1024)" />
		</addColumn>
		<addColumn tableName="Instruction">
			<column name="executed" type="DATETIME" />
		</addColumn>
	</changeSet>

	<changeSet id="6" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="Discount" columnName="detail_textile" />
		</preConditions>
		<dropColumn tableName="Discount" columnName="detail_textile" />
	</changeSet>

	<changeSet id="7" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<and>
				<columnExists tableName="TutorRole" columnName="detail" />
				<columnExists tableName="TutorRole" columnName="detail_textile" />
			</and>
		</preConditions>
		<dropColumn tableName="TutorRole" columnName="detail" />
		<dropColumn tableName="TutorRole" columnName="detail_textile" />
	</changeSet>

	<changeSet id="8" author="anton" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<and>
				<columnExists tableName="PaymentTransaction"
					columnName="sessionId" />
			</and>
		</preConditions>
		<dropColumn tableName="PaymentTransaction" columnName="sessionId" />
		<addColumn tableName="PaymentIn">
			<column name="sessionId" type="varchar(100)" />
		</addColumn>
		<addColumn tableName="PaymentIn">
			<column name="gatewayReference" type="varchar(64)" />
		</addColumn>
		<addColumn tableName="PaymentIn">
			<column name="gatewayResponse" type="MEDIUMTEXT" />
		</addColumn>
	</changeSet>

	<changeSet id="9" author="ksenia" context="production"
		runOnChange="true">
		<modifyDataType tableName="Enrolment" columnName="status"
			newDataType="enum('Pending','In Transaction','Success','Failed','Cancelled', 'Refunded')" />
	</changeSet>

	<changeSet id="9" author="olga" context="production"
		runOnChange="true">
		<addColumn tableName="Discount">
			<column name="discountType" type="enum('Percent','Dollar','Fee override')" />
		</addColumn>
	</changeSet>

	<changeSet id="11" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="Discount" columnName="discountType" />
		</preConditions>
		<modifyDataType tableName="Discount" columnName="discountType"
			newDataType="smallint" />
	</changeSet>

	<changeSet id="12" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="PaymentIn" columnName="type" />
			</not>
		</preConditions>
		<addColumn tableName="PaymentIn">
			<column name="type" type="smallint" />
		</addColumn>
	</changeSet>

	<changeSet id="13" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<sqlCheck expectedResult="0">
					select count(*) from PaymentIn
					where type is null
				</sqlCheck>
			</not>
		</preConditions>
		<!-- All payments with credit cards are set to 2=Credit Card -->
		<sql>update PaymentIn set type=2 where type is null and
			creditCardNumber is not null;</sql>
		<!-- All payments without credit cards are set to 0=Cash -->
		<sql>update PaymentIn set type=0 where type is null and
			creditCardNumber is null;</sql>
	</changeSet>

	<changeSet id="14" author="ksenia" context="production"
		runOnChange="true">
		<sql>alter table PaymentIn change type type smallint(6) NOT NULL
			DEFAULT 2</sql>
	</changeSet>

	<changeSet id="15" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<indexExists indexName="WebNode_defaultWebURLalias"
				tableName="WebNode" />
		</preConditions>
		<dropForeignKeyConstraint constraintName="WebNode_defaultWebURLalias"
			baseTableName="WebNode" />
		<dropIndex tableName="WebNode" indexName="WebNode_defaultWebURLalias" />
	</changeSet>

	<changeSet id="16" author="anton" context="production"
		runOnChange="true">
		<addColumn tableName="Contact">
			<column name="passwordRecoveryKey" type="varchar(16)" />
			<column name="passwordRecoverExpire" type="DATETIME" />
		</addColumn>
	</changeSet>

	<changeSet id="17" author="ksenia" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists
					foreignKeyName="WebNode_defaultWebURLalias" foreignKeyTableName="WebNode" />
			</not>
		</preConditions>
		<addForeignKeyConstraint constraintName="WebNode_defaultWebURLalias"
			baseTableName="WebNode" baseColumnNames="defaultURLalias"
			referencedTableName="WebURLAlias" referencedColumnNames="id" />
	</changeSet>

	<changeSet id="18" author="anton" context="production"
		runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="Contact" columnName="passwordRecoveryKey" />
		</preConditions>
		<addUniqueConstraint tableName="Contact"
			columnNames="passwordRecoveryKey" constraintName="recoverKey_unique" />
	</changeSet>

	<changeSet id="19" author="ksenia" context="production"
		runOnChange="true">
		<update tableName="BinaryInfo">
			<column name="isWebVisible" value="1" />
			<where>isWebVisible IS NULL</where>
		</update>
		<modifyDataType tableName="BinaryInfo" columnName="isWebVisible"
			newDataType="tinyint(1) NOT NULL" />
	</changeSet>

	<changeSet id="20" author="anton" context="production"
		runOnChange="true">
		<addColumn tableName="PaymentIn">
			<column name="dateBanked" type="DATETIME" />
		</addColumn>
		<addColumn tableName="PaymentOut">
			<column name="dateBanked" type="DATETIME" />
			<column name="datePaid" type="DATETIME" />
		</addColumn>
	</changeSet>

	<changeSet id="21" author="anton" context="production"
		runOnChange="true">
		
		<createTable tableName="Discussion">
			<column name="id" type="BIGINT(20)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="courseClassId" type="BIGINT(20)">
				<constraints nullable="false"/>
			</column>
		</createTable>
		
		<addAutoIncrement tableName="Discussion" columnName="id" columnDataType="BIGINT"/>
		<addForeignKeyConstraint constraintName="courseClassFK" baseTableName="Discussion" baseColumnNames="courseClassId" referencedTableName="CourseClass" referencedColumnNames="id"/>

		<createTable tableName="DiscussionThread">
			<column name="id" type="BIGINT(20)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="discussionId" type="BIGINT(20)">
				<constraints nullable="false"/>
			</column>
		</createTable>
		
		<addAutoIncrement tableName="DiscussionThread" columnName="id" columnDataType="BIGINT"/>
		<addForeignKeyConstraint constraintName="discussionFK" baseTableName="DiscussionThread" baseColumnNames="discussionId" referencedTableName="Discussion" referencedColumnNames="id"/>
		
		<createTable tableName="DiscussionComment">
			<column name="id" type="BIGINT(20)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="discussionThreadId" type="BIGINT(20)">
				<constraints nullable="false"/>
			</column>
			<column name="body" type="MEDIUMTEXT">
				<constraints nullable="false"/>
			</column>
			<column name="isDeleted" type="BOOLEAN">
				<constraints nullable="false"/>
			</column>
		</createTable>
		
		<addDefaultValue tableName="DiscussionComment" columnName="isDeleted" defaultValue="0"/>
		<addAutoIncrement tableName="DiscussionComment" columnName="id" columnDataType="BIGINT"/>
		<addForeignKeyConstraint constraintName="discussionThreadFK" baseTableName="DiscussionComment" baseColumnNames="discussionThreadId" referencedTableName="DiscussionThread" referencedColumnNames="id"/>
		
		<createTable tableName="DiscussionCommentContact">
			<column name="id" type="BIGINT(20)">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="discussionCommentId" type="BIGINT(20)">
				<constraints nullable="false"/>
			</column>
			<column name="contactId" type="BIGINT(20)">
				<constraints nullable="false"/>
			</column>
			<column name="isNew" type="BOOLEAN">
				<constraints nullable="false"/>
			</column>
		</createTable>
		
		<addDefaultValue tableName="DiscussionCommentContact" columnName="isNew" defaultValue="1"/>
		<addAutoIncrement tableName="DiscussionCommentContact" columnName="id" columnDataType="BIGINT"/>
		<addForeignKeyConstraint constraintName="commentFK" baseTableName="DiscussionCommentContact" baseColumnNames="discussionCommentId" referencedTableName="DiscussionComment" referencedColumnNames="id"/>
		<addForeignKeyConstraint constraintName="contactFK" baseTableName="DiscussionCommentContact" baseColumnNames="contactId" referencedTableName="Contact" referencedColumnNames="id"/>
		
	</changeSet>
	
	<changeSet id="22" author="anton" context="production" runOnChange="true">
		<addNotNullConstraint tableName="ConcessionType" columnName="isConcession" columnDataType="TINYINT(1)" defaultNullValue="1" />
		<addNotNullConstraint tableName="ConcessionType" columnName="isEnabled" columnDataType="TINYINT(1)" defaultNullValue="1" />
	</changeSet>
	
	<changeSet id="23" author="anton" context="production" runOnChange="true">
		<sqlFile path="tables_mysql_innodb.sql"/>
	</changeSet>

	<changeSet id="24" author="xenia" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="College" columnName="timeZone"/>
			</not>
		</preConditions>
		<addColumn tableName="College">
			<column name="timeZone" type="varchar(64)"/>
		</addColumn>
	</changeSet>
	
	<changeSet id="25" author="olga" context="production" runOnChange="true">
		<update tableName="PaymentIn">
			<column name="source" value="W"/>
			<where>source IS NULL</where>
		</update>
		<modifyDataType tableName="PaymentIn" columnName="source" newDataType="VARCHAR(1) NOT NULL"/>
	</changeSet>
	
	<changeSet id="26" author="xenia" context="production" runOnChange="true">
		<addNotNullConstraint tableName="College" columnDataType="varchar(64)" columnName="timeZone" defaultNullValue="Australia/Sydney" />
		<sql>update College set timeZone='Australia/Perth' where id=3219</sql>
	</changeSet>
	
	<changeSet id="27" author="anton" context="production" runOnChange="true">
		<!-- setting default value to IN_TRANSACTION -->
		<addNotNullConstraint tableName="PaymentOut" columnDataType="INT(11)" columnName="status" defaultNullValue="2" />
		<addNotNullConstraint tableName="PaymentOut" columnDataType="varchar(1)" columnName="source" defaultNullValue="O" />
	</changeSet>
	
	<changeSet id="28" author="anton" context="production" runOnChange="true">
		<!-- Fix source for refunds, which should be 'O' not 'W' -->
		<sql>update Invoice set source='O' where description='Refund for enrolments' and source='W'</sql>
		<addNotNullConstraint tableName="Invoice" columnDataType="varchar(1)" columnName="source" defaultNullValue="O" />
		<addNotNullConstraint tableName="Enrolment" columnDataType="varchar(1)" columnName="source" defaultNullValue="O" />	
	</changeSet>
	
	<changeSet id="29" author="olga" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="Tag" columnName="specialType"/>
			</not>
		</preConditions>
		<addColumn tableName="Tag">
			<column name="specialType" type="SMALLINT"/>
		</addColumn>
	</changeSet>
	
	<changeSet id="30" author="olga" context="production" runOnChange="true">
		<sql>update TutorRole set isConfirmed=true where confirmedDate is not null;</sql>
		<sql>update TutorRole set isConfirmed=false where confirmedDate is null;</sql>
	</changeSet>

	<changeSet id="31" author="viacheslav" context="production" runOnChange="true">
		<sql>update Contact set uniqueCode=SUBSTR(MD5(RAND()), 1, 16) where uniqueCode is null;</sql>
		<addNotNullConstraint tableName="Contact" columnDataType="varchar(16)" columnName="uniqueCode" defaultNullValue="SUBSTR(MD5(RAND()), 1, 16)"/>
		<addUniqueConstraint tableName="Contact" columnNames="uniqueCode" constraintName="uniqueCode_unique" />
	</changeSet>
	
	<changeSet id="32" author="viacheslav" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="ContactRelation"/>
			</not>
		</preConditions>
		<createTable tableName="ContactRelation">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="angelId" type="BIGINT"></column>
			<column name="collegeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="createdOn" type="DATETIME"></column>
			<column name="fromContactId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="modifiedOn" type="DATETIME"></column>
			<column name="toContactId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="typeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addUniqueConstraint tableName="ContactRelation" columnNames="angelId,collegeId" constraintName="angelAndCollegeForContactRelation_unique"/>
	</changeSet>
	
	<changeSet id="33" author="viacheslav" context="production" runOnChange="true">	
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="ContactRelationType"/>
			</not>
		</preConditions>
		<createTable tableName="ContactRelationType">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="angelId" type="BIGINT"></column>
			<column name="collegeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="createdOn" type="DATETIME"></column>
			<column name="fromContactName" type="VARCHAR(100)">
				<constraints nullable="false"/>
			</column>
			<column name="toContactName" type="VARCHAR(100)">
				<constraints nullable="false"/>
			</column>
			<column name="modifiedOn" type="DATETIME"></column>
		</createTable>
		<addUniqueConstraint tableName="ContactRelationType" columnNames="angelId,collegeId" constraintName="angelAndCollegeForContactRelationType_unique"/>
	</changeSet>
	
	<changeSet id="34" author="viacheslav" context="production" runOnChange="true">	
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="DiscountMembership"/>
			</not>
		</preConditions>
		<createTable tableName="DiscountMembership">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="angelId" type="BIGINT"></column>
			<column name="collegeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="createdOn" type="DATETIME"></column>
			<column name="applyToMemberOnly" type="SMALLINT">
				<constraints nullable="false"/>
			</column>
			<column name="discountId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="membershipProductId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="modifiedOn" type="DATETIME"></column>
		</createTable>
		<addUniqueConstraint tableName="DiscountMembership" columnNames="angelId,collegeId" constraintName="angelAndCollegeForDiscountMembership_unique"/>
	</changeSet>
	
	<changeSet id="35" author="viacheslav" context="production" runOnChange="true">	
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="DiscountMembershipRelationType"/>
			</not>
		</preConditions>
		<createTable tableName="DiscountMembershipRelationType">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="angelId" type="BIGINT"></column>
			<column name="collegeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="createdOn" type="DATETIME"></column>
			<column name="contactRelationTypeId" type="BIGINT"></column>
			<column name="membershipDiscountId" type="BIGINT"></column>
			<column name="modifiedOn" type="DATETIME"></column>
		</createTable>
		<addUniqueConstraint tableName="DiscountMembershipRelationType" columnNames="angelId,collegeId" 
			constraintName="angelAndCollegeForDiscountMembershipRelationType_unique"/>
	</changeSet>
	
	<changeSet id="36" author="viacheslav" context="production" runOnChange="true">	
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="Product"/>
			</not>
		</preConditions>	
		<createTable tableName="Product">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="angelId" type="BIGINT"></column>
			<column name="collegeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="createdOn" type="DATETIME"></column>
			<column name="description" type="VARCHAR(8000)"></column>
			<column name="expiryDays" type="INT"></column>
			<column name="expiryType" type="INT"></column>
			<column name="isOnSale" type="SMALLINT">
				<constraints nullable="false"/>
			</column>
			<column name="isWebVisible" type="SMALLINT">
				<constraints nullable="false"/>
			</column>
			<column name="modifiedOn" type="DATETIME"></column>
			<column name="name" type="VARCHAR(500)"></column>
			<column name="notes" type="VARCHAR(8000)"></column>
			<column name="sku" type="VARCHAR(100)"></column>
			<column name="type" type="INT">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addUniqueConstraint tableName="Product" columnNames="angelId,collegeId" constraintName="angelAndCollegeForProduct_unique"/>
	</changeSet>
	
	<changeSet id="37" author="viacheslav" context="production" runOnChange="true">	
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="ProductItem"/>
			</not>
		</preConditions>
		<createTable tableName="ProductItem">
			<column name="id" type="BIGINT" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="angelId" type="BIGINT"></column>
			<column name="collegeId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="createdOn" type="DATETIME"></column>
			<column name="contactId" type="BIGINT"></column>
			<column name="expiryDate" type="DATETIME"></column>
			<column name="idKey" type="VARCHAR(50)"></column>
			<column name="invoiceLineId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="modifiedOn" type="DATETIME"></column>
			<column name="productId" type="BIGINT">
				<constraints nullable="false"/>
			</column>
			<column name="redeemedInvoiceLineId" type="BIGINT"></column>
			<column name="type" type="INT"></column>
		</createTable>
		<addUniqueConstraint tableName="ProductItem" columnNames="angelId,collegeId" constraintName="angelAndCollegeForProductItem_unique"/>
	</changeSet>
	
	<changeSet id="38" author="viacheslav" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="Discount" columnName="isCodeRequired"/>
		</preConditions>
		<dropColumn tableName="Discount" columnName="isCodeRequired"/>
	</changeSet>
	
	<changeSet id="39" author="viacheslav" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="Discount" columnName="isConcession"/>
		</preConditions>
		<dropColumn tableName="Discount" columnName="isConcession"/>
	</changeSet>
	
	<changeSet id="40" author="anton" context="production" runOnChange="true">
		<sql>alter table Invoice change column status status VARCHAR(30)</sql>
	</changeSet>
	
	<changeSet id="41" author="anton" context="production" runOnChange="true">
		<sql>alter table Enrolment change column status status_tmp VARCHAR(30)</sql>
		<sql>alter table Enrolment add column status INTEGER</sql>
		<sql>update Enrolment set status=2 where status_tmp in ('Pending', 'In Transaction')</sql>
		<sql>update Enrolment set status=3 where status_tmp='Success'</sql>
		<sql>update Enrolment set status=4 where status_tmp='Failed'</sql>
		<sql>update Enrolment set status=8 where status_tmp='Cancelled'</sql>
		<sql>update Enrolment set status=9 where status_tmp='Refunded'</sql>
		<sql>alter table Enrolment change column status status INTEGER not null</sql>
		<dropColumn tableName="Enrolment" columnName="status_tmp"/>
	</changeSet>
	
	<changeSet id="42" author="viacheslav" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
			<indexExists indexName="session"
				tableName="PaymentIn" />
			</not>
		</preConditions>
		<sql>ALTER TABLE PaymentIn ADD INDEX session (sessionId ( 8 ) );</sql>
	</changeSet>
	
	<changeSet id="43" author="dzmitry" context="production" runOnChange="true">
		<sql>insert into Preference (collegeId, name, value_string) 
				select c.id, 'payment.gateway.type', 
				case  
    				when c.paymentGatewayType = 2 then 'PAYMENT_EXPRESS'
    				when c.paymentGatewayType = 0 then 'TEST'
    				when c.paymentGatewayType is null then 'DISABLED'
				end
			 from College c where c.billingCode is not null;</sql>
	</changeSet>
	
	<changeSet id="44" author="anton" context="production" runOnChange="true">
		<dropColumn tableName="Invoice" columnName="status"/>
	</changeSet>
	
	<changeSet id="45" author="anton" context="production" runOnChange="true">
		<update tableName="Preference">
			<column name="value_string" value="/terms-conditions?wrap=false"/>
			<where>name='feature.enrolmentDisclosure' and collegeId=3093</where>
		</update>
	</changeSet>
	
	<changeSet id="46" author="viacheslav" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
			<indexExists indexName="status"
				tableName="PaymentIn" />
			</not>
		</preConditions>
		<sql>ALTER TABLE PaymentIn ADD INDEX status (status);</sql>
	</changeSet>
	
	<changeSet id="47" author="viacheslav" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
			<indexExists indexName="modified"
				tableName="PaymentIn" />
			</not>
		</preConditions>
		<sql>ALTER TABLE PaymentIn ADD INDEX modified (modified);</sql>
	</changeSet>
	
	<changeSet id="48" author="anton" context="production" runOnChange="true">
		<addColumn tableName="PaymentOut">
			<column name="statusNotes" type="varchar(100)" />
		</addColumn>
	</changeSet>
	
	<changeSet id="49" author="viacheslav" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="PaymentTransaction" columnName="soapResponse"/>
			</not>
		</preConditions>
		<sql>ALTER TABLE PaymentTransaction ADD COLUMN soapResponse TEXT NULL  AFTER response ;</sql>
	</changeSet>
	
	<changeSet id="50" author="viacheslav" context="production" runOnChange="true">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="PaymentOutTransaction" columnName="soapResponse"/>
			</not>
		</preConditions>
		<sql>ALTER TABLE PaymentOutTransaction ADD COLUMN soapResponse TEXT NULL  AFTER response ;</sql>
	</changeSet>
	
	<changeSet id="51" author="anton" context="production" runOnChange="true">
		<dropNotNullConstraint tableName="Certificate" columnName="qualificationId" columnDataType="BIGINT(20)"/>
	</changeSet>
	
	<changeSet id="52" author="dzmitry" context="production" runOnChange="true">
		<addNotNullConstraint tableName="Attendance" columnName="angelId" columnDataType="BIGINT"/>
	</changeSet>
	
	<!-- changeSet id="53" author="dzmitry" context="production" runOnChange="true">
		<sql>update Invoice i set i.totalGst = i.totalExGst + i.totalGst where ABS(i.totalGst) &lt; ABS(i.totalExGst);</sql>
	</changeSet -->
		
	<!--changeSet id="XYZ" author="viacheslav" context="production" runOnChange="true">
		<addUniqueConstraint tableName="PaymentInLine" columnNames="paymentInId,invoiceId" constraintName="paymentInIdAndInvoiceIdForPaymentInLine_unique"/>
	</changeSet-->

</databaseChangeLog>