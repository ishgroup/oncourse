<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

	<changeSet id="cleanChangeLog" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<tableExists tableName="DATABASECHANGELOG"/>
		</preConditions>
		<sql>
			DELETE FROM DATABASECHANGELOG;
		</sql>
	</changeSet>

	<changeSet id="1" author="pavel" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="limitPreviousEnrolment" tableName="Discount"/>
			</not>
		</preConditions>
		<addColumn tableName="Discount">
			<column name="limitPreviousEnrolment" type="SMALLINT"/>
		</addColumn>
	</changeSet>

	<changeSet id="2" author="pavel" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="colour" tableName="Tag"/>
			</not>
		</preConditions>
		<addColumn tableName="Tag">
			<column name="colour" type="CHAR(6)"/>
		</addColumn>
	</changeSet>

	<changeSet id="3" author="pavel" runOnChange="false" runAlways="false" context="production">
		<sql>UPDATE Discount SET limitPreviousEnrolment = 0</sql>
	</changeSet>

	<changeSet id="4" author="artyom" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists columnName="dataType" tableName="CustomFieldType"/>
			</not>
		</preConditions>
		<addColumn tableName="CustomFieldType">
			<column name="dataType" type="SMALLINT"/>
		</addColumn>
	</changeSet>

	<changeSet id="5" author="artyom" runOnChange="false" runAlways="false" context="production">
		<sql>ALTER TABLE PaymentIn MODIFY COLUMN statusNotes MEDIUMTEXT</sql>
	</changeSet>

	<changeSet id="6" author="artyom" runOnChange="false" runAlways="false" context="production">
		<sql>ALTER TABLE EmailTemplate DROP FOREIGN KEY fk_EmailTemplate_College</sql>
		<sql>ALTER TABLE EmailTemplate DROP INDEX college_name</sql>
		<sql>ALTER TABLE EmailTemplate ADD FOREIGN KEY (collegeId) REFERENCES College(id)</sql>

	</changeSet>

	<changeSet id="7" author="artyom" runOnChange="false" runAlways="false" context="production">
		<sql>ALTER TABLE Script DROP FOREIGN KEY fk_Script_College</sql>
		<sql>ALTER TABLE Script DROP INDEX college_name</sql>
		<sql>ALTER TABLE Script ADD FOREIGN KEY (collegeId) REFERENCES College(id)</sql>

	</changeSet>

	<changeSet id="8" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<modifyDataType tableName="Course" columnName="code" newDataType="VARCHAR(128)"/>
	</changeSet>
	
	<changeSet id="9" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="EntityRelationType"/>
			</not>
		</preConditions>
		<createTable tableName="EntityRelationType">
			<column name="id" type="BIGINT" autoIncrement="true" >
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="created" type="datetime" />
			<column name="modified" type="datetime" />
			<column name="name" type="VARCHAR(100)" />
			<column name="toName" type="VARCHAR(100)" />
			<column name="fromName" type="VARCHAR(100)" />
			<column name="description" type="TEXT" />
			<column name="isShownOnWeb" type="SMALLINT" />
			<column name="shoppingCart" type="SMALLINT" />
			<column name="considerHistory" type="SMALLINT" />
			<column name="discountId" type="BIGINT" />
			<column name="collegeId" type="BIGINT" />
			<column name="angelId" type="BIGINT" />
		</createTable>
	</changeSet>

	<changeSet id="10" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="EntityRelation" columnName="typeId"/>
			</not>
		</preConditions>
		<addColumn tableName="EntityRelation">
			<column name="typeId" type="BIGINT" />
		</addColumn>
	</changeSet>

	<changeSet id="11" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="fk_EntityRelation_Type"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseTableName="EntityRelation"
								 baseColumnNames="typeId"
								 constraintName="fk_EntityRelation_Type"
								 referencedTableName="EntityRelationType"
								 referencedColumnNames="id"
								 validate="true"/>
	</changeSet>

	<changeSet id="12" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<foreignKeyConstraintExists foreignKeyName="EntityRelationType_Discount_fk"/>
			</not>
		</preConditions>
		<addForeignKeyConstraint baseTableName="EntityRelationType"
								 baseColumnNames="discountId"
								 constraintName="EntityRelationType_Discount_fk"
								 referencedTableName="Discount"
								 referencedColumnNames="id"
								 validate="true"/>
	</changeSet>

	<changeSet id="13" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="EntityRelation" columnName="fromEntityIdentifierTemp"/>
			</not>
		</preConditions>
		<addColumn tableName="EntityRelation">
			<column name="fromEntityIdentifierTemp" type="VARCHAR(100)" />
		</addColumn>
	</changeSet>

	<changeSet id="14" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="EntityRelation" columnName="toEntityIdentifierTemp"/>
			</not>
		</preConditions>
		<addColumn tableName="EntityRelation">
			<column name="toEntityIdentifierTemp" type="VARCHAR(100)" />
		</addColumn>
	</changeSet>

	<changeSet id="15" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifierTemp"/>
		</preConditions>
		<update tableName="EntityRelation">
			<column name="fromEntityIdentifierTemp" value="Course" />
			<where>fromEntityIdentifier=1</where>
		</update>
	</changeSet>

	<changeSet id="16" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifierTemp"/>
		</preConditions>
		<update tableName="EntityRelation">
			<column name="toEntityIdentifierTemp" value="Course" />
			<where>toEntityIdentifier=1</where>
		</update>
	</changeSet>

	<changeSet id="17" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifierTemp"/>
		</preConditions>
		<update tableName="EntityRelation">
			<column name="toEntityIdentifierTemp" value="Product" />
			<where>toEntityIdentifier=2</where>
		</update>
	</changeSet>

	<changeSet id="18" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifier"/>
		</preConditions>
		<dropNotNullConstraint tableName="EntityRelation" columnName="fromEntityIdentifier" columnDataType="SMALLINT" />
	</changeSet>

	<changeSet id="19" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifier"/>
		</preConditions>
		<dropNotNullConstraint tableName="EntityRelation" columnName="toEntityIdentifier" columnDataType="SMALLINT" />
	</changeSet>

	<changeSet id="20" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifier"/>
		</preConditions>
		<modifyDataType tableName="EntityRelation" columnName="fromEntityIdentifier" newDataType="VARCHAR(100)" />
	</changeSet>

	<changeSet id="21" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifier"/>
		</preConditions>
		<modifyDataType tableName="EntityRelation" columnName="toEntityIdentifier" newDataType="VARCHAR(100)" />
	</changeSet>

	<changeSet id="22" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifier"/>
		</preConditions>
		<sql>UPDATE EntityRelation SET fromEntityIdentifier = fromEntityIdentifierTemp</sql>
	</changeSet>

	<changeSet id="23" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifier"/>
		</preConditions>
		<sql>UPDATE EntityRelation SET toEntityIdentifier = toEntityIdentifierTemp</sql>
	</changeSet>

	<changeSet id="24" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifier"/>
		</preConditions>
		<addNotNullConstraint tableName="EntityRelation" columnName="fromEntityIdentifier" columnDataType="VARCHAR(100)" />
	</changeSet>

	<changeSet id="25" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifier"/>
		</preConditions>
		<addNotNullConstraint tableName="EntityRelation" columnName="toEntityIdentifier" columnDataType="VARCHAR(100)" />
	</changeSet>

	<changeSet id="26" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="fromEntityIdentifierTemp"/>
		</preConditions>
		<dropColumn tableName="EntityRelation" columnName="fromEntityIdentifierTemp" />
	</changeSet>

	<changeSet id="27" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="EntityRelation" columnName="toEntityIdentifierTemp"/>
		</preConditions>
		<dropColumn tableName="EntityRelation" columnName="toEntityIdentifierTemp" />
	</changeSet>

	<changeSet id="28" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="Checkout"/>
			</not>
		</preConditions>
		<createTable tableName="Checkout">
			<column name="id" type="BIGINT" autoIncrement="true" >
				<constraints nullable="false" primaryKey="true"/>
			</column>
			<column name="created" type="datetime" />
			<column name="modified" type="datetime" />
			<column name="collegeId" type="BIGINT" />
			<column name="angelId" type="BIGINT" />
			<column name="UUID" type="VARCHAR(30)" >
				<constraints nullable="false"/>
			</column>
			<column name="shoppingCart" type="JSON" >
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="29" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<and>
				<columnExists tableName="AssessmentSubmission" columnName="studentComments"/>
				<columnExists tableName="AssessmentSubmission" columnName="tutorComments"/>
			</and>
		</preConditions>
		<dropColumn tableName="AssessmentSubmission">
			<column name="studentComments"/>
			<column name="tutorComments"/>
		</dropColumn>
	</changeSet>

	<changeSet id="30" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<not>
				<and>
					<columnExists tableName="AssessmentSubmission" columnName="submittedOn"/>
					<columnExists tableName="AssessmentSubmission" columnName="markedOn"/>
				</and>
			</not>
		</preConditions>
		<addColumn tableName="AssessmentSubmission">
			<column name="submittedOn" type="datetime"/>
			<column name="markedOn" type="datetime"/>
		</addColumn>
	</changeSet>

	<changeSet id="31" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="AssessmentSubmission" columnName="submittedById"/>
		</preConditions>
		<dropNotNullConstraint tableName="AssessmentSubmission" columnName="submittedById" columnDataType="BIGINT"/>
	</changeSet>

	<changeSet id="32" author="rostislav" runOnChange="false" runAlways="false" context="production">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="AssessmentSubmission" columnName="submittedById"/>
		</preConditions>
		<renameColumn tableName="AssessmentSubmission" oldColumnName="submittedById" newColumnName="markedById" columnDataType="BIGINT"/>
	</changeSet>
</databaseChangeLog>
