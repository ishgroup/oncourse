apply plugin: 'java'
apply plugin: 'application'

configurations {
    swagger
}

dependencies {
    testCompile 'org.apache.commons:commons-dbcp2:2.1.1'
    testCompile 'org.apache.commons:commons-pool2:2.4.2'
    testCompile project(':common:test-functions')
    swagger project(':common:codegen:jaxrs')
}

targetCompatibility = '1.8'
sourceCompatibility = '1.8'

test {
    systemProperty "oncourse.jdbc.url", System.getProperty("oncourse.jdbc.url")
    systemProperty "oncourse.jdbc.user", System.getProperty("oncourse.jdbc.user")
    systemProperty "oncourse.jdbc.password", System.getProperty("oncourse.jdbc.password")
}

compileGroovy {
    groovyOptions.configurationScript = file("config.groovy")
}

processResources.doLast {
    file("${buildDir}/resources/VERSION").text = version ?: "SNAPSHOT"
    javaexec {
        classpath = configurations.swagger
        main = 'io.swagger.codegen.SwaggerCodegen'
        args  = [ 'generate', 
                  '-i', "${project.projectDir}/src/main/resources/$swaggerName",
                  '-l', 'html',
                  '-t', "${rootDir}/common/codegen/common/src/main/resources/htmlDocs",
                  '-o', "${buildDir}/doc"]
    }
}

// the following block isn't working for me when placed in the top level build.gradle
startScripts {
    unixStartScriptGenerator.template = resources.text.fromFile("${project.rootDir}/buildSrc/src/main/resources/applicationStartScript.sh")

}

distZip {
    applicationDistribution.from( "${buildDir}/resources/VERSION" ) {
        into('.')
    }
}

publishing {
// For deploying to our repo
    publications {
        executables(MavenPublication) {
            artifact(distZip) {
                classifier "executable"
                extension "zip"
            }
        }
    }
}



task (swagger, type: JavaExec) {
    main = 'ish.oncourse.codegen.cxf.WillowJaxRsGenerator'
    classpath = configurations.swagger
    args  = [ servicesPackage, modelPackage, project.projectDir, "${project.projectDir}/src/main/resources/$swaggerName" ]
}