<html t:type="pagestructure" title="literal:NTIS"
	xmlns:t="http://tapestry.apache.org/schema/tapestry_5_1_0.xsd" xmlns:p="tapestry:parameter">
	
	<h4>Reference data last updated on <span id="lastUpdate">${lastUpdateDate}</span></h4>
	
	<div id="updateInput">
		<t:form t:id="updateForm">
			<table>
				<tr>
					<td>From:</td>
					<td><t:textfield t:id="dateFrom" size="10" t:validate="required"/></td>
					<td>To:</td>
					<td><t:textfield t:id="dateTo" size = "10" t:validate="required"/></td>
				</tr>
				<tr>
					<td><t:submit t:id="update" class="btn btn-primary" value="Update" /></td>
				</tr>
			</table>
		</t:form>
	</div>
	
	<div id="results"></div>
	
	<t:if test="updateInProgress">
		<script type="text/javascript">jQuery(function() {jQuery("#updateInput").hide();});</script>
	</t:if>
	
	<script type="text/javascript">
		jQuery(function() {		
			jQuery( "#dateFrom" ).datepicker({ dateFormat: 'dd/mm/yy' });
			jQuery( "#dateTo" ).datepicker({ dateFormat: 'dd/mm/yy' });
			
			var now = new Date();
			var twoDigitMonth = ((now.getMonth().length + 1) === 1) ? (now.getMonth() + 1) : '0' + (now.getMonth() + 1);
			var currentDate = now.getDate() + '/' + twoDigitMonth + '/' + now.getFullYear();
			jQuery("#dateTo").val(currentDate);
			jQuery("#dateFrom").val(jQuery("#lastUpdate").text());
			
			var statusUpdate = function() {
				
				jQuery.getJSON('${ntisResultUrl}', function(data) {
			  		
					var items = [];
			  		
			  		jQuery.each(data, function(key, val) {
			  			if (val.match(/^END_.*$/)) {
			  				jQuery("#lastUpdate").text(val.split('_')[1]);
			  				jQuery("#updateInput").show();
			  			}
			  			else {
			  				items.push('<li>' + val + '</li>');	
			  			}
				  	});
			  		
			  		jQuery('#results').empty();
			  		jQuery('<ul/>', {'class': 'my-new-list', html: items.join('')}).appendTo('#results');
			  	});
			};
			
			setTimeout(statusUpdate, 1000);
			setInterval(statusUpdate, 5000);
		});
	</script>
	
</html>	