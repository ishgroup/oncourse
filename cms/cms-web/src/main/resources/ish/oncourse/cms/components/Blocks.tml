<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<t:container xmlns:t="http://tapestry.apache.org/schema/tapestry_5_1_0.xsd"
	xmlns:p="tapestry:parameter" lang="en">
	
	<t:block t:id="editBlock">
		<span t:type="blockedit" block="prop:selectedBlock" updateZone="prop:blockZone"/>
	</t:block>
	
	<t:zone t:id="blockZone">
        <div class="cms-main-head">
        	<div class="cms-main-title">
                <h1 class="cms-page-title">Blocks</h1>
            </div>
            <div class="cms-main-controls">
				<span class="cms-ico-plus"></span>
                <a t:type="actionLink" t:id="newBlock" zone="blockZone" class="cms-main-control">Add new block</a>
			</div>
            <div class="cms-search-block">
				<input id="blockFilter" type="text" maxlength="300" class="cms-span2 cms-search-query"/>
                <!-- button type="button" class="cms-btn-select"></button>
                <button class="cms-btn-search" type="button"></button-->
            </div>
        </div>

        <div class="cms-content cms-page-blocks">
            <table class="cms-cont-table" id="blocks">
				<t:loop source="webContentService.blocks" value="block">
					<div t:type="blockItem" block="block"/>
				</t:loop>
            </table>
        </div>
        
        <script type="text/javascript">
			jQuery(function() {
				jQuery('#blockFilter').search('#blocks tr', function(on) {
		            on.all(function(results) {
		             
		            });
	
		            on.reset(function() {
		              jQuery('#blocks tr').show();
		            });
	
		            on.empty(function() {
		              jQuery('#blocks tr').hide();
		            });
	
		            on.results(function(results) {
		              jQuery('#blocks tr').hide();
		              results.show();
		            });
		          });
				
				/*jQuery('#blocks tbody tr').mouseover(function() {
					jQuery(this).addClass('selectedRow');
				}).mouseout(function() {
				    jQuery(this).removeClass('selectedRow');
				}).click(function() {
					var zoneManager = Tapestry.findZoneManagerForZone('blockZone');
					zoneManager.updateFromURL('${editBlockUrl}' + jQuery(this).attr('id'));
				});*/
			});
			
			function showDeleteBlockConfirmation(id) {
			jQuery("#deleteBlockModal"+id).dialog({
			 	resizable: false,
				height:140,
				width:380,
				modal: true,
				buttons: {
					"Delete": function() {
						jQuery(this).dialog("close");
						jQuery("a[id='dBlock_"+id+"']").trigger('click');
					},
					Cancel: function() {
						jQuery(this).dialog("close");
					}
				}
			});
			};
			
			function fireDeleteBlock(elementId) {
				var actionId = elementId.substring(7);
				var actionLink = jQuery("a[clientId='deleteBlock"+actionId+"']");
				var actionHref = actionLink.attr("href");
				jQuery.ajax({
					type: "POST",
					data: "id="+actionId,
					url: actionHref,
					complete: function(data){
						if(data.responseText=="{status: 'OK'}"){
							var id = this.data.substring(3);
							jQuery("tr[id='block_row_"+id+"']").remove();
						} else if(data.responseText=="{status: 'session timeout'}"){
							window.location.reload();
						} else if(data.responseText=="{status: 'FAILED'}") {
							alert("This block cannot be deleted since it is has been used by a theme(s).");
						}else{
							alert("The block cannot be removed due some exception.");
						}
					}, 
					async:true
				});
				return false;
			};
		</script>
	
	</t:zone>
        
</t:container>