<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<t:container xmlns:t="http://tapestry.apache.org/schema/tapestry_5_1_0.xsd">

	<div class="cms-main-head">
    	<div class="cms-main-title">
            <h1 class="cms-page-title">Menus</h1>
        </div>
        <div class="cms-main-controls">
            <span class="cms-ico-plus"></span>
             <a class="cms-main-control cms_add_menuitem">Add new menu</a>
		</div>
        <div class="cms-search-block form-search">
            <input id="menuFilter" type="text" maxlength="300" class="span2 search-query"/>
            <!-- button type="button" class="cms-btn-select"></button>
            <button class="cms-btn-search" type="button"></button-->
        </div>
   	</div>

     <div class="cms-content cms-page-menu" id="menus">

		<ul class="cms-menu-pages cms_navmenu_list cms_draggable cms_sortable">
 
            <t:loop source="rootMenu.webMenus" value="currentMenu">
				<t:delegate to="menuItem"/>
			</t:loop>
		
	    	<t:block>
	        	<div t:id="menuItem">
	            	<t:delegate to="menuItem"/>
	        	</div>
	    	</t:block>
        </ul>
	</div>

	<li class="hidden cms_newmenuitem" style="display:none;">
		
		<span>
			<span class="cms-menu-pages-n cms-first">
				<span class="editable">New menu item</span> 
				<span class="cms-ico-edit"></span>
			</span>
			<div class="error"/>
			<span class="cms-menu-pages-url">
				URL: <span class="editable"></span>
				<span class="cms-ico-edit"></span>
			</span>
	
			<span class="cms-menu-pages-dr">
				<span class="cms-ico-drag"></span> 
				Drag &amp; Place
			</span>
		
			<span class="cms-menu-pages-dl cms-last">
				<span class="cms-ico-del"></span>
				<a>Delete</a>
				<div style="display:none;" title="Are you sure you wish to delete this item?">
					<p>Are you sure you wish to delete this item?</p>
				</div>
			</span>
		</span>
	</li>
	<script type="text/javascript">
		jQuery(function(){
			jQuery.menubuilder(${suggestResults});
		});
		
		jQuery(function() {
			jQuery('#menuFilter').search('#menus li', function(on) {
	            on.all(function(results) {
	             
	            });

	            on.reset(function() {
	              jQuery('#menus li').show();
	            });

	            on.empty(function() {
	              if (jQuery('#menuFilter').is(':focus')) {
	              	jQuery('#menus li').hide();
	              }
	            });

	            on.results(function(results) {
	              if (jQuery('#menuFilter').is(':focus')) {
	                jQuery('#menus li').hide();
	                results.show();
	              }
	            });
	          });
			
		});
		
		function showDeleteMenuConfirmation(id) {
			jQuery("#deleteMenuModal"+id).dialog({
			 	resizable: false,
				height:140,
				width:380,
				modal: true,
				buttons: {
					"Delete": function() {
						jQuery(this).dialog("close");
						fireDeleteMenu(id);
					},
					Cancel: function() {
						jQuery(this).dialog("close");
					}
				}
			});
		};

		function fireDeleteMenu(elemID) {
			jQuery.ajax({
				type: "POST",
				data: "id="+elemID,
				url: '/ma.remove',
				complete: function(data){
					if(data.responseText=="{status: 'OK'}"){
						jQuery(".cms_navmenu_list #m_" + elemID).remove();
					}else if(data.responseText=="{status: 'session timeout'}"){
						window.location.reload();
					} else{
						alert("The node with children cannot be removed.");
					}
				}, 
				async:true
			});
			return false;
		}
	</script>
	
</t:container>